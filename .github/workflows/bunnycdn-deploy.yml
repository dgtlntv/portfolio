name: Build and Deploy to BunnyCDN

on:
    push:
        branches:
            - v2
    pull_request:
        types:
            - closed
        branches:
            - v2

jobs:
    build-and-deploy:
        # Only run this job if the PR is merged (not just closed) or if it's a direct push to v2
        if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install Dependencies
              run: npm ci

            - name: Build
              run: npm run build

            - name: Deploy to BunnyCDN
              uses: ayeressian/bunnycdn-storage-deploy@v2.2.5
              with:
                  source: "dist"
                  destination: ""
                  storageZoneName: ${{ secrets.STORAGE_NAME }}
                  storagePassword: ${{ secrets.STORAGE_PASSWORD }}
                  accessKey: ${{ secrets.STORAGE_KEY }}
                  pullZoneId: ${{ secrets.ZONE_ID }}
                  upload: "true"
                  remove: "true"
                  purgePullZone: "true"
